# YOLO_8Cell 血细胞检测与分类项目完整说明

## 项目概述

YOLO_8Cell是一个基于YOLO（You Only Look Once）系列模型的血细胞检测与分类项目，旨在自动识别和定位显微镜下的8种不同类型血细胞。项目采用PySide6构建用户友好的图形界面，支持多种模型类型，实现了人机结合的标注与训练工作流程。

## 检测类别

### 血细胞类型（8种主要类别，13种细分类型）

1. **嗜碱性粒细胞 (basophil)**
2. **嗜酸性粒细胞 (eosinophil)**
3. **中性粒细胞 (neutrophil)**
   - BNE - 杆状核中性粒细胞
   - SNE - 分叶核中性粒细胞
4. **淋巴细胞 (lymphocyte)**
5. **单核细胞 (monocyte)**
6. **核红细胞 (erythroblast)**
7. **血小板 (platelet)**
8. **未成熟粒细胞 (ig)**
   - MY (髓系原始细胞)
   - PMY (早幼粒细胞)
   - MMY (中幼粒细胞)

*注：前5项为经典的白细胞五大类型，未成熟粒细胞包含多个亚型*

| 阶段 | 名称/缩写            | 中文名       | 所属系列   | 备注               |
| -- | ---------------- | --------- | ------ | ---------------- |
| 1  | **MY**           | 髓系原始细胞    | 粒系最早前体 | 最早可识别的髓系细胞       |
| 2  | **PMY**          | 早幼粒细胞     | 粒系     | 开始合成初级颗粒         |
| 3  | **MMY**          | 中幼粒细胞     | 粒系     | 开始合成次级颗粒，最后可分裂阶段 |
| 4  | **IG**（未成熟粒细胞）   | 晚幼粒 + 杆状核 | 粒系     | 统称：晚幼粒 → 杆状核     |
| 5  | **BNE**          | 杆状核中性粒细胞  | 中性粒    | 未完全成熟，核呈杆状       |
| 6  | **SNE**          | 分叶核中性粒细胞  | 中性粒    | 成熟中性粒细胞          |
| 7  | **eosinophil**   | 嗜酸性粒细胞    | 嗜酸粒    | 发育路径类似中性粒，稍晚     |
| 8  | **basophil**     | 嗜碱性粒细胞    | 嗜碱粒    | 最晚成熟的粒细胞         |
| 9  | **erythroblast** | 核红细胞（幼红）  | 红细胞系   | 最早有核红细胞阶段        |
| 10 | **monocyte**     | 单核细胞      | 单核-巨噬系 | 成熟后进入外周血         |
| 11 | **lymphocyte**   | 淋巴细胞      | 淋巴系    | 部分在骨髓，部分在胸腺成熟    |
| 12 | **platelet**     | 血小板       | 巨核系    | 非细胞，巨核细胞脱落的胞质碎片  |

MY → PMY → MMY → IG → BNE → SNE → Eos → Baso → Erythro → Mono → Lymph → Platelet

## 项目架构与核心特性

### 多模型策略
- **独立小模型**：为每种细胞类型单独训练专用模型（8个独立模型）
- **综合大模型**：整合所有细胞类型训练的综合模型（支持13种细分类型）
- **人机协作**：结合人工标注的高质量和机器标注的高效率

### PySide6图形界面功能
1. **多模型支持**：
   - 支持加载多种YOLO格式的.pt模型文件
   - 支持目标检测和图像分类两种模式

2. **检测控制功能**：
   - 实时调整检测参数（置信度阈值、IOU阈值等）
   - 单视图和双视图切换
   - 模型选择和加载管理

3. **可视化功能**：
   - 实时显示检测结果和边界框
   - 类别标签和置信度显示
   - 检测统计信息展示

## 项目结构详解

```
YOLO_8Cell/
├── Code/                          # 核心代码目录
│   ├── train_all_cell_types.py    # 训练各细胞类型独立模型
│   ├── train_all_cells_yolo11m.py # 训练综合模型（13类别）
│   ├── batch_auto_label.py        # 批量自动标注脚本
│   ├── yolo11m.pt                 # YOLO11中型号预训练权重
│   └── yolo11n.pt                 # YOLO11纳米级预训练权重
│
├── PySide6/yolo_gui/              # 图形用户界面
│   ├── main_window.py             # 主窗口实现
│   ├── YoloTracker.py             # YOLO跟踪器类
│   ├── baseDetect.py              # 基础检测类
│   └── __init__.py                # 包初始化文件
│
├── datasets_full/                  # 完整数据集
│   ├── basophil/                  # 嗜碱性粒细胞
│   │   ├── images/                # 图像文件
│   │   └── labels/                # 标签文件
│   ├── eosinophil/                # 嗜酸性粒细胞
│   └── ...（其他6种细胞类型）
│
├── datasets_small/                # 小规模数据集（人工标注）
│   ├── basophil/                  # 嗜碱性粒细胞小数据集
│   │   ├── images/                # 代表性图像
│   │   ├── labels/                # 人工标注标签
│   │   ├── basophil.yaml          # 数据集配置
│   │   └── labels.cache           # 标签缓存
│   └── ...（其他7种细胞类型）
│
├── models_small/                  # 小模型训练记录
│   ├── basophil_train/            # 嗜碱性粒细胞训练
│   │   ├── weights/best.pt        # 最佳模型权重
│   │   ├── args.yaml              # 训练参数
│   │   ├── results.png            # 训练结果可视化
│   │   └── confusion_matrix.png   # 混淆矩阵
│   └── ...（其他7种细胞类型训练）
│
└── models_full/                   # 综合模型保存目录
```

## 工作流程

### 阶段1：人工标注与初始训练
1. **精选代表性样本**：为每种细胞类型选择高质量的显微镜图像
2. **高质量人工标注**：使用标注工具手动标注边界框和类别
3. **小模型训练**：使用小数据集分别训练8个独立模型
4. **模型验证**：评估每个小模型的性能，保存最佳权重

### 阶段2：机器辅助标注
1. **批量自动标注**：使用训练好的小模型对完整数据集进行自动标注
2. **标注质量控制**：设置置信度阈值过滤低质量检测结果
3. **生成初步标签**：为大量未标注图像生成YOLO格式标签

### 阶段3：人工确认与修正
1. **抽样检查**：随机抽查机器标注的结果
2. **错误修正**：修正错误的类别标签和边界框
3. **质量保证**：确保所有标注达到项目质量标准

### 阶段4：综合模型训练
1. **数据集整合**：合并所有经过验证的标注数据
2. **综合模型训练**：使用完整数据集训练支持13种类别的综合模型
3. **模型优化**：调整超参数，优化模型性能
4. **最终评估**：在测试集上评估综合模型的性能

## PySide6图形界面详细说明

### 主窗口功能 (main_window.py)
- **模型管理**：
  - 支持加载多个.pt模型文件
  - 模型切换和状态显示
  - 模型性能信息展示

- **检测控制**：
  - 实时调整检测参数
  - 置信度阈值滑块（0.0-1.0）
  - IOU阈值滑块（0.0-1.0）
  - 图像尺寸选择

- **视图模式**：
  - 单视图：原始图像与检测结果叠加显示
  - 双视图：并排显示原始图像和检测结果
  - 缩放和平移控制

- **文件操作**：
  - 支持多种图像格式（jpg, png, bmp等）
  - 批量图像处理
  - 结果保存功能

### 基础检测类 (baseDetect.py)
```python
class baseDetect:
    def __init__(self):
        self.imgsz = 640      # 推理图像尺寸
        self.conf = 0.5       # 置信度阈值
        self.iou = 0.45       # IOU阈值
        self.classes = None   # 指定检测类别
        # 类别颜色映射
        self.colors = [(255,0,0), (0,255,0), ...]
    
    def draw_box(self, img, box, label, color):
        # 在图像上绘制边界框和标签
        pass
```

### YOLO跟踪器类 (YoloTracker.py)
```python
class YoloTracker(baseDetect):
    def __init__(self):
        super().__init__()
        self.model = None     # YOLO模型实例
    
    def init_model(self, model_path):
        # 初始化YOLO模型，检测GPU可用性
        pass
    
    def detect(self, im):
        # 执行目标检测，返回标注后的图像和检测信息
        pass
```

## 关键脚本功能

### 1. 训练脚本
**train_all_cell_types.py**：
- 训练指定细胞类型的独立模型
- 支持自定义数据集路径和输出目录
- 错误处理和路径验证

**train_all_cells_yolo11m.py**：
- 训练13类别综合模型
- 详细的类别映射和索引管理
- 完整的日志记录系统

### 2. 标注脚本
**batch_auto_label.py**：
- 批量处理8种细胞类型的自动标注
- 基于相对路径的路径管理
- 标注过程日志记录

## 数据集配置

每个小数据集包含YAML配置文件，如`basophil.yaml`：
```yaml
names:
- basophil
nc: 1
path: c:\Users\Eplis\Desktop\YOLO_8Cell
train: small_datasets/basophil/images
val: small_datasets/basophil/images
```

## 使用方法

### 1. 启动GUI界面
```bash
cd YOLO_8Cell\PySide6\yolo_gui
python main_window.py
```

### 2. 使用GUI进行检测
1. **加载模型**：点击"加载模型"按钮选择.pt文件
2. **加载图像**：点击"打开图像"选择检测图片
3. **调整参数**：使用滑块调整置信度和IOU阈值
4. **执行检测**：点击"开始检测"按钮
5. **查看结果**：在界面中查看检测结果和统计信息

### 3. 训练新模型
```bash
# 训练单个细胞类型模型
python Code/train_all_cell_types.py --cell-type basophil

# 训练综合模型
python Code/train_all_cells_yolo11m.py
```

### 4. 批量标注
```bash
# 使用小模型进行自动标注
python Code/batch_auto_label.py --model-dir models_small --dataset-dir datasets_full
```

## 技术栈

- **深度学习框架**：Ultralytics YOLO11 (PyTorch)
- **图形界面**：PySide6 (Qt for Python)
- **编程语言**：Python 3.8+
- **图像处理**：OpenCV, PIL
- **GPU加速**：CUDA (可选)
- **数据处理**：NumPy, Pandas

## 性能优化建议

1. **GPU加速**：确保安装正确版本的PyTorch和CUDA
2. **批处理**：对于批量标注，适当调整批处理大小
3. **模型选择**：
   - yolo11n.pt：轻量级，适合快速推理
   - yolo11m.pt：平衡精度和速度
   - 自定义模型：针对特定细胞类型优化

4. **内存管理**：
   - 调整图像尺寸减少内存占用
   - 使用数据加载器优化训练过程
   - 定期清理不必要的中间文件

## 项目优势

1. **多模型灵活性**：支持独立模型和综合模型，适应不同应用场景
2. **人机协作效率**：显著减少人工标注工作量
3. **用户友好界面**：直观的GUI降低使用门槛
4. **完整的工作流**：从数据准备到模型部署的完整解决方案
5. **可扩展性**：易于添加新的细胞类型或改进检测算法

## 未来扩展方向

1. **实时检测**：集成摄像头实时血细胞检测
2. **模型集成**：使用模型融合技术提高检测精度
3. **云端部署**：支持Web界面和远程访问
4. **移动端应用**：开发移动设备上的血细胞检测应用
5. **多模态数据**：整合病理报告和临床数据

该项目为医学图像分析提供了完整的解决方案，特别适合临床实验室、医学研究和教育应用场景。