# YOLO多功能检测系统

## 📋 项目简介

YOLO多功能检测系统是一个基于PySide6和Ultralytics YOLO的图形化目标检测应用程序。支持图像、视频和摄像头实时检测，具备多种YOLO模型类型（目标检测、分类、关键点检测等）的自动识别和加载功能。

## 🎯 功能特性

### 核心功能
- **多模型支持**：自动识别YOLO模型类型（检测/分类/关键点/跟踪）
- **多输入源**：支持图片、视频、摄像头输入
- **实时处理**：视频和摄像头实时检测与显示
- **参数调节**：IOU阈值、置信度、延迟、线宽等参数实时调整
- **统计显示**：实时显示检测数量、置信度、推理时间、FPS
- **媒体控制**：视频播放/暂停、进度条拖动、时间显示

### 特色功能
- **智能模型分析**：选择PT文件时自动识别模型类型和任务
- **延迟加载**：模型在点击"开始"时才正式加载，提升启动速度
- **模块化设计**：各功能模块独立，易于扩展和维护
- **跨平台**：支持Windows、macOS、Linux系统
- **现代UI**：专业的深色主题界面设计

## 📁 项目文件结构

```
yolo-detection-system/
├── main.py                    # 程序入口点，创建应用实例
├── window_ui.py               # UI界面定义和组件
├── window_code.py             # 核心逻辑控制器
└── 各个YOLO功能模块：
    ├── yolo_analyzer.py       # 模型分析器和目标检测器
    ├── yolo_classifier.py     # 图像分类器（待实现）
    ├── yolo_keypoint.py       # 关键点检测器（待实现）
    └── yolo_Tracker.py        # 目标跟踪器（待实现）
```

## 📄 文件功能说明

### 1. `main.py` - 程序入口点
- **功能**：创建Qt应用实例，初始化UI和逻辑控制器，启动事件循环
- **主要职责**：
  - 初始化应用程序
  - 设置应用元数据（名称、版本、作者）
  - 创建UI窗口和逻辑控制器
  - 启动Qt事件循环
  - 异常处理和错误报告

### 2. `window_ui.py` - UI界面组件
- **功能**：定义所有用户界面组件和布局
- **主要组件**：

#### `AspectRatioDisplayLabel` 类
- 保持16:9显示比例的图像标签
- 自动调整大小保持比例
- 实现左右贴边效果

#### `LeftDisplayPanel` 类
- **左侧展示面板**（4:3容器）
- **包含**：
  - 16:9显示区域（图像/视频显示）
  - 文件名叠加显示（黑色背景上）
  - 视频控制组件（播放/暂停按钮、进度条、时间显示）
- **特性**：
  - 支持三种模式：图片、视频、摄像头
  - 智能文件名显示（过长自动截断）
  - 视频控制根据模式启用/禁用

#### `RightControlPanel` 类
- **右侧控制面板**
- **主要功能区**：
  1. **模型信息组**：显示模型名称、任务类型、输入尺寸、类别数量
  2. **推理参数组**：IOU阈值、置信度、延迟、线宽的滑块调节
  3. **实时统计组**：检测数、置信度、推理时间、FPS显示
  4. **控制按钮组**：开始/停止推理按钮
  5. **保存截图按钮**
- **特性**：支持垂直滚动，参数实时调整

#### `YOLOMainWindowUI` 类
- **主窗口UI类**：整合左右面板，提供菜单栏和工具栏
- **包含**：
  - 单行工具栏（文件、打开模型、打开图片、打开视频、打开摄像头、帮助）
  - 下拉菜单功能
  - 左右面板布局管理

### 3. `window_code.py` - 核心逻辑控制器
- **功能**：处理所有业务逻辑，连接UI和YOLO模块
- **核心组件**：

#### `SimpleVideoPlayer` 类
- **极简视频播放器**
- **职责**：
  - 负责流畅播放视频/摄像头
  - 不涉及YOLO推理，专注于显示
  - 提供帧抓取接口
- **特性**：
  - 独立播放线程
  - 视频进度控制和跳转
  - 摄像头支持

#### `FrameGrabberWorker` 类
- **帧抓取工作者**
- **职责**：
  - 从播放器抓取帧并发送给YOLO
  - 控制处理频率（避免每帧都处理）
  - 提取统计信息
- **特性**：
  - 按间隔抓取（默认每5帧）
  - 独立工作线程
  - 错误处理和状态报告

#### `YOLOMainWindowLogic` 类
- **主逻辑控制器**
- **核心功能**：
  1. **模型管理**：PT文件分析、模块加载、参数传递
  2. **媒体处理**：图片加载、视频播放、摄像头捕获
  3. **状态控制**：播放/暂停、开始/停止推理
  4. **UI协调**：更新显示、处理用户交互
  5. **错误处理**：异常捕获和用户提示

### 4. `yolo_analyzer.py` - 模型分析器
- **功能**：分析YOLO模型文件并执行目标检测
- **核心特性**：

#### `YOLOAnalyzer` 类
- **模型分析功能**：
  - 自动识别模型任务类型（检测/分类/关键点/分割/跟踪）
  - 提取模型信息（类别数、输入尺寸、文件大小）
  - 多方法分析（Ultralytics API、PyTorch加载、元数据分析）

- **检测器功能**：
  - 真正的YOLO模型加载和执行
  - 单帧处理接口
  - 参数控制（IOU阈值、置信度阈值）

#### `ModelLoader` 类
- **动态模块加载器**：
  - 根据任务类型加载对应模块
  - 提供统一的接口
  - 支持错误回退机制

## 🔄 项目运行逻辑

### 启动流程
1. `main.py` 创建Qt应用实例
2. 创建 `YOLOMainWindowUI` 实例（UI窗口）
3. 创建 `YOLOMainWindowLogic` 实例（逻辑控制器）
4. 逻辑控制器初始化UI状态和信号连接
5. 显示主窗口，启动事件循环

### 模型加载流程
1. **用户点击"打开模型"按钮**
2. 弹出文件选择对话框，选择.pt文件
3. **分析阶段**：
   - 调用 `yolo_analyzer.py` 的 `analyze_model()` 方法
   - 快速分析模型信息（不加载完整模型）
   - 自动识别任务类型（检测/分类/关键点等）
   - 显示模型信息到右侧面板
4. **延迟加载**：此时模型文件被分析，但完整的YOLO模型未加载到内存

### 推理处理流程
1. **用户选择媒体文件**（图片/视频/摄像头）
2. **用户点击"开始"按钮**
3. **真正加载阶段**：
   - 根据模型类型动态导入对应模块
   - 创建YOLO模块实例（此时才真正加载模型）
   - 设置参数（IOU阈值、置信度等）
4. **处理阶段**：
   - **图片模式**：直接处理单张图片
   - **视频/摄像头模式**：
     - 启动 `SimpleVideoPlayer` 播放视频
     - 启动 `FrameGrabberWorker` 抓取帧
     - 抓取器按间隔发送帧给YOLO模块处理
     - 实时更新统计信息到UI

### 视频播放与控制流程
1. **播放流程**：
   - `SimpleVideoPlayer` 在独立线程中解码视频
   - 每帧转换为QImage发送给UI显示
   - 更新进度条和时间显示
2. **控制流程**：
   - 播放/暂停按钮切换播放状态
   - 进度条拖动触发视频跳转
   - 文件名字符叠加显示

### 信号-槽机制
项目使用PySide6的信号-槽机制进行组件间通信：
- UI事件 → 逻辑处理
- 播放器状态 → UI更新
- 推理结果 → 统计显示
- 用户操作 → 参数调整

## ⚙️ 环境要求

### 必需库
```bash
# 核心库
pip install PySide6
pip install ultralytics
pip install opencv-python
pip install numpy
pip install torch
pip install torchvision
```

### 推荐环境
- Python 3.8+
- CUDA 11.3+（可选，用于GPU加速）
- 4GB+ RAM
- 支持OpenGL 3.0+的显卡

## 🚀 快速开始

1. **克隆或下载项目**
```bash
git clone <repository-url>
cd yolo-detection-system
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **准备YOLO模型**
- 将.pt模型文件放在项目目录
- 支持的模型：YOLOv8/YOLOv11的检测/分类/关键点/分割模型

4. **运行程序**
```bash
python main.py
```

## 📖 使用指南

### 基本使用步骤
1. **启动程序**：运行 `python main.py`
2. **加载模型**：点击"打开模型"选择.pt文件
   - 程序自动分析模型类型
   - 右侧显示模型信息
3. **选择媒体**：
   - **图片**：点击"打开图片"
   - **视频**：点击"打开视频"
   - **摄像头**：点击"打开摄像头"
4. **调整参数**：根据需要调整IOU阈值、置信度等
5. **开始推理**：点击"开始"按钮
6. **查看结果**：左侧显示检测结果，右侧显示统计信息
7. **保存结果**：点击"保存截图"保存当前画面

### 注意事项
1. **首次使用**：确保安装了所有必需库
2. **模型选择**：程序会自动识别模型类型，如识别失败可手动选择
3. **内存使用**：大模型可能需要较多内存，建议从CPU模式开始
4. **实时性**：调整"延迟(ms)"参数可平衡实时性和CPU使用率

## 🔧 扩展开发

### 添加新功能模块
1. 在对应目录创建新的YOLO模块文件（如 `yolo_segmenter.py`）
2. 实现类 `YOLOSegmenter`，继承或参考 `YOLOAnalyzer`
3. 在 `yolo_analyzer.py` 的 `TASK_MAPPING` 和 `MODEL_TYPE_MAPPING` 中添加新类型
4. 在 `window_code.py` 的 `_select_module_type` 中添加对应选项

### 自定义UI
1. 修改 `window_ui.py` 中的组件样式
2. 调整布局比例和参数
3. 添加新的控件和信号

### 性能优化
1. **GPU加速**：在 `_load_yolo_module()` 中将 `device='cpu'` 改为 `device='cuda'`
2. **批量处理**：修改 `FrameGrabberWorker` 的抓取间隔
3. **内存优化**：调整视频分辨率和帧率

## 🐛 故障排除

### 常见问题
1. **无法导入ultralytics**
   ```bash
   pip install ultralytics --upgrade
   ```

2. **模型加载失败**
   - 检查模型文件路径是否正确
   - 确保模型文件完整未损坏
   - 尝试重新下载模型

3. **视频无法播放**
   - 安装合适的视频编码器
   - 检查视频文件格式是否支持
   - 确保ffmpeg已安装

4. **界面显示异常**
   - 检查PySide6版本
   - 更新显卡驱动
   - 调整系统DPI设置

5. **性能问题**
   - 降低视频分辨率
   - 增加抓取间隔
   - 使用轻量级模型

### 调试模式
- 查看控制台输出获取详细错误信息
- 调整日志级别：在代码中添加 `import logging; logging.basicConfig(level=logging.DEBUG)`

## 📝 版本更新

### v1.0.0 (当前版本)
- ✅ 基础UI框架
- ✅ 多模型类型自动识别
- ✅ 图片/视频/摄像头支持
- ✅ 实时统计显示
- ✅ 参数调节功能
- ✅ 视频控制功能
- ✅ 截图保存功能

### 计划功能
- [ ] 更多YOLO模块实现（分类、关键点、跟踪）
- [ ] 批量处理功能
- [ ] 结果导出（JSON、CSV、视频）
- [ ] 模型训练界面
- [ ] 多摄像头支持
- [ ] 云端模型加载

## 📄 许可证

本项目采用MIT许可证。详见LICENSE文件。

## 👥 贡献指南

1. Fork本仓库
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建Pull Request

## 📧 联系方式

如有问题或建议，请通过以下方式联系：
- 项目仓库 Issues
- Email: [your-email@example.com]
- 作者: Sephoration

---

**感谢使用YOLO多功能检测系统！希望这个工具能帮助您更高效地进行计算机视觉任务。**